name: Deploy Model to Azure ML

on:
  workflow_dispatch:
    inputs:
      model_name:
        description: "Model name to register"
        required: false
        type: string
        default: "churn-prediction-model"

jobs:
  deploy:
    name: Register Model in Azure ML
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4.1.1

      - name: Set up Python
        uses: actions/setup-python@v5.0.0
        with:
          python-version: "3.10"

      - name: Install Dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Train Model
        run: python scripts/train_model.py --output-dir artifacts

      - name: Register Model in Azure ML
        env:
          AZURE_TENANT_ID: ${{ secrets.AZURE_TENANT_ID }}
          AZURE_CLIENT_ID: ${{ secrets.AZURE_CLIENT_ID }}
          AZURE_CLIENT_SECRET: ${{ secrets.AZURE_CLIENT_SECRET }}
        run: |
          python scripts/register_model.py \
            --subscription-id "${{ secrets.AZURE_SUBSCRIPTION_ID }}" \
            --resource-group "${{ secrets.AZURE_RESOURCE_GROUP }}" \
            --workspace-name "${{ secrets.AZURE_ML_WORKSPACE_NAME }}" \
            --model-path artifacts/model.pkl \
            --model-name "${{ github.event.inputs.model_name }}"

      - name: Deployment Summary
        if: always()
        run: |
          echo "## Model Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Property | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Model Name | ${{ github.event.inputs.model_name }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Triggered by | ${{ github.actor }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Commit | ${{ github.sha }} |" >> $GITHUB_STEP_SUMMARY
